<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ò–Ω–≥—É—à—Å–∫–æ‚Äì–†—É—Å—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å</title>

<!-- LAME.js –¥–ª—è MP3 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.0/lame.min.js"></script>

<style>
body { font-family: Arial; background: var(--bg); color: var(--fg); margin:0; padding:20px; }
:root { --bg:#fff; --fg:#000; --card:#f0f0f0; }
.dark { --bg:#1b1b1b; --fg:#e6e6e6; --card:#2a2a2a; }

.container { max-width: 900px; margin:auto; }

button { padding:8px 14px; margin:4px; cursor:pointer; }
input, textarea {
    width:100%; padding:10px; margin:6px 0; font-size:16px;
}

.item {
    background:var(--card);
    padding:15px; margin:10px 0;
    border-radius:10px;
}

.edit-block {
    background:var(--card); padding:20px;
    border-radius:10px; margin-top:20px;
}

.tts { cursor:pointer; font-size:22px; margin-left:5px; }

#suggestions .sug { padding:6px; cursor:pointer; }
#suggestions .sug:hover { background:#ccc; }

.highlight { background:yellow; }
</style>
</head>

<body>
<div class="container">

<h1>–ò–Ω–≥—É—à—Å–∫–æ‚Äì–†—É—Å—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å</h1>

<button onclick="login()">–í–æ–π—Ç–∏</button>
<button onclick="logout()">–í—ã–π—Ç–∏</button>
<span id="authStatus"></span>

<br><br>

<button onclick="setMode('auto')">–ê–≤—Ç–æ</button>
<button onclick="setMode('ru2ing')">Ru ‚Üí Ing</button>
<button onclick="setMode('ing2ru')">Ing ‚Üí Ru</button>
<button onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
<button onclick="openAudioAdmin()">–ê—É–¥–∏–æ</button>

<br><br>

<input id="query" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ..." oninput="autocomplete()" />
<div id="suggestions"></div>
<button onclick="search()">–ü–æ–∏—Å–∫</button>

<div id="result"></div>

<!-- –°–µ–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editor" class="edit-block" style="display:none;">
<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞</h3>

–†—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ:
<input id="edit_russian">

–ò–Ω–≥—É—à—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):
<input id="edit_ingush">

–ß–∞—Å—Ç—å —Ä–µ—á–∏:
<input id="edit_pos">

–¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ:
<textarea id="edit_definition"></textarea>

<button onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button onclick="closeEditor()">–ó–∞–∫—Ä—ã—Ç—å</button>

<button onclick="downloadUpdated()">‚¨á –°–∫–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å</button>
</div>

<!-- –ê—É–¥–∏–æ –ø–∞–Ω–µ–ª—å -->
<div id="audioAdmin" class="edit-block" style="display:none;">
<h3>üé§ –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ —Å–ª–æ–≤–∞</h3>

–ò–Ω–≥—É—à—Å–∫–æ–µ —Å–ª–æ–≤–æ:<br>
<input id="rec_word" placeholder="iyrcha" />

<button onclick="startRecording()">‚ñ∂ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
<button onclick="stopRecording()">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

<p id="rec_status"></p>
<a id="download_rec" style="display:none;" download>‚¨á –°–∫–∞—á–∞—Ç—å MP3</a>

<hr>

<h3>‚¨Ü –ó–∞–≥—Ä—É–∑–∫–∞ MP3 –≤ GitHub</h3>

GitHub Token:
<input id="gh_token" placeholder="ghp_xxx..." oninput="saveToken()" />

<button onclick="uploadLastMP3()">–ó–∞–≥—Ä—É–∑–∏—Ç—å MP3</button>
</div>

</div>

<script>
const PASSWORD = "ingush-secret";
let MODE = "auto";
let DICT = {};
let currentKey = null;
let mediaRecorder = null;
let chunks = [];
let lastMP3Blob = null;


/* ============================  –¢–ï–ú–ê  ============================ */
function toggleTheme(){
    document.body.classList.toggle("dark");
}


/* ======================  –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø  =========================== */
function updateAuth(){
    authStatus.textContent = localStorage.getItem("authorized")
        ? "‚úî –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"
        : "‚úñ –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
}
updateAuth();

function login(){
    const p = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:");
    if(p === PASSWORD){
        localStorage.setItem("authorized", "true");
        updateAuth();
    } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
}

function logout(){
    localStorage.removeItem("authorized");
    updateAuth();
}


/* ======================  –ó–ê–ì–†–£–ó–ö–ê –°–õ–û–í–ê–†–Ø  ====================== */
async function loadDict(){
    const r = await fetch("merged_dictionary_rebuilt.json");
    DICT = await r.json();

    const edits = localStorage.getItem("dict_edits");
    if(edits) Object.assign(DICT, JSON.parse(edits));
}
loadDict();

function setMode(m){ MODE=m; }


/* ======================  –ü–û–ò–°–ö + AUTOCOMPLETE  ================== */
function autocomplete(){
    const q = query.value.toLowerCase().trim();
    if(!q){ suggestions.innerHTML=""; return; }

    const list = Object.keys(DICT)
        .filter(k => k.toLowerCase().startsWith(q))
        .slice(0,10);

    suggestions.innerHTML = list.map(k =>
        `<div class="sug" onclick="useSuggestion('${k}')">${k}</div>`
    ).join("");
}

function useSuggestion(w){
    query.value = w;
    suggestions.innerHTML = "";
    search();
}

function search(){
    const q = query.value.toLowerCase().trim();
    let keys = [];

    if(MODE==="ru2ing"){
        keys = Object.keys(DICT).filter(k => k.toLowerCase().includes(q));
    }
    else if(MODE==="ing2ru"){
        keys = Object.keys(DICT).filter(k =>
            DICT[k].ingush.some(t => t.toLowerCase().includes(q))
        );
    }
    else {
        keys = Object.keys(DICT).filter(k =>
            k.toLowerCase().includes(q) ||
            DICT[k].ingush.some(t => t.toLowerCase().includes(q))
        );
    }

    renderResult(keys);
}

function renderResult(keys){
    result.innerHTML = keys.map(k=>{
        const e = DICT[k];
        const i = e.ingush.join(", ");

        return `
        <div class="item">
            <b>${k}</b>
            <span class="tts" onclick="speakRu('${k}')">üó£</span><br>

            ${i}
            <span class="tts" onclick="playIng('${e.ingush[0]}')">üéß</span><br>

            <small>${e.definition || ""}</small><br><br>

            ${localStorage.getItem("authorized")
                ? `<button onclick="openEditor('${k}')">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`
                : ""}
        </div>`;
    }).join("");
}


/* =======================  –û–ó–í–£–ß–ö–ê RU / ING  ===================== */
function speakRu(text){
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ru-RU";
    speechSynthesis.speak(u);
}

function playIng(text){
    const url = "https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&q="+
        encodeURIComponent(text)+"&tl=ru";
    new Audio(url).play();
}


/* ========================  –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï  ======================= */
function openEditor(k){
    currentKey = k;
    const e = DICT[k];

    edit_russian.value = e.russian;
    edit_ingush.value = e.ingush.join(", ");
    edit_pos.value = e.pos || "";
    edit_definition.value = e.definition || "";

    editor.style.display="block";
}

function closeEditor(){ editor.style.display="none"; }

function saveEdit(){
    const rus = edit_russian.value.trim();
    const ing = edit_ingush.value.split(",").map(s=>s.trim());

    DICT[rus] = {
        russian: rus,
        ingush: ing,
        pos: edit_pos.value.trim(),
        definition: edit_definition.value.trim(),
        source: "edited"
    };

    localStorage.setItem("dict_edits", JSON.stringify(DICT));
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
}

function downloadUpdated(){
    const blob = new Blob([JSON.stringify(DICT,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "dictionary_updated.json";
    a.click();
}


/* ========================  –ê–£–î–ò–û –ó–ê–ü–ò–°–¨  ========================= */
async function startRecording(){
    chunks = [];
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.start();
    rec_status.innerText = "üéô –ó–∞–ø–∏—Å—å...";
}

async function stopRecording(){
    mediaRecorder.stop();
    rec_status.innerText = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–∏—Å–∏...";

    mediaRecorder.onstop = async ()=>{
        const wavBlob = new Blob(chunks,{type:"audio/wav"});
        const trimmed = await trimSilence(wavBlob);
        lastMP3Blob = await wavToMp3(trimmed);

        const name = rec_word.value.trim() + ".mp3";

        download_rec.href = URL.createObjectURL(lastMP3Blob);
        download_rec.download = name;
        download_rec.style.display="inline-block";

        rec_status.innerText = "‚úî –ì–æ—Ç–æ–≤–æ: " + name;
    };
}

/* ===== WAV ‚Üí trimmed WAV ===== */
async function trimSilence(blob, threshold=0.02){
    const ctx = new AudioContext();
    const buf = await blob.arrayBuffer();
    const audio = await ctx.decodeAudioData(buf);
    const data = audio.getChannelData(0);

    let start=0, end=data.length-1;

    while(Math.abs(data[start])<threshold && start<end) start++;
    while(Math.abs(data[end])<threshold && end>start) end--;

    const trimmed = data.slice(start, end);
    const newBuf = ctx.createBuffer(1, trimmed.length, audio.sampleRate);
    newBuf.copyToChannel(trimmed,0);

    return encodeWav(newBuf);
}

/* WAV encoding */
function encodeWav(buffer){
    const numSamples = buffer.length;
    const sampleRate = buffer.sampleRate;
    const bytesPerSample = 2;
    const blockAlign = bytesPerSample * 1;

    const buf = new ArrayBuffer(44 + numSamples * bytesPerSample);
    const view = new DataView(buf);

    function writeString(off, str){
        for(let i=0;i<str.length;i++) view.setUint8(off+i, str.charCodeAt(i));
    }

    writeString(0, "RIFF");
    view.setUint32(4, 36 + numSamples * bytesPerSample, true);
    writeString(8, "WAVEfmt ");
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * bytesPerSample, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, 16, true);
    writeString(36, "data");
    view.setUint32(40, numSamples * bytesPerSample, true);

    let offset = 44;
    const channel = buffer.getChannelData(0);
    for(let i=0;i<channel.length;i++){
        let s = Math.max(-1, Math.min(1, channel[i]));
        view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        offset += 2;
    }

    return new Blob([buf],{type:"audio/wav"});
}

/* ===== WAV ‚Üí MP3 (128 kbps) ===== */
async function wavToMp3(blob){
    const buffer = await blob.arrayBuffer();
    const data = new Uint8Array(buffer);

    const wav = lamejs.WavHeader.readHeader(new DataView(buffer));
    const samples = new Int16Array(buffer, wav.dataOffset, wav.dataLen / 2);

    const mp3enc = new lamejs.Mp3Encoder(1, wav.sampleRate, 128); // 128 kbps
    const mp3Data = [];

    let remaining = samples.length;
    let position = 0;

    while(remaining > 0){
        const chunkSize = 1152;
        const left = samples.subarray(position, position + chunkSize);
        const mp3buf = mp3enc.encodeBuffer(left);
        if(mp3buf.length > 0) mp3Data.push(mp3buf);
        position += chunkSize;
        remaining -= chunkSize;
    }

    const end = mp3enc.flush();
    if(end.length > 0) mp3Data.push(end);

    return new Blob(mp3Data, {type:"audio/mp3"});
}


/* =======================  –ó–ê–ì–†–£–ó–ö–ê MP3 –í GITHUB  ================= */
function saveToken(){
    localStorage.setItem("gh_token", gh_token.value.trim());
}

async function uploadLastMP3(){
    if(!lastMP3Blob) return alert("–ù–µ—Ç MP3! –°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π –∑–∞–ø–∏—Å—å.");

    const token = localStorage.getItem("gh_token");
    if(!token) return alert("–í–≤–µ–¥–∏—Ç–µ GitHub Token");

    const file = rec_word.value.trim() + ".mp3";
    const repo = "ganizhevamirkhan/ingush-language";
    const path = "audio/" + file;

    const buf = await lastMP3Blob.arrayBuffer();
    const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));

    await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method:"PUT",
        headers:{ "Authorization":"token "+token },
        body: JSON.stringify({
            message: "–î–æ–±–∞–≤–ª–µ–Ω MP3: " + file,
            content: b64
        })
    });

    alert("‚úî MP3 –∑–∞–≥—Ä—É–∂—ë–Ω!");
}


/* ========================  –ê–£–î–ò–û –ü–ê–ù–ï–õ–¨ ========================= */
function openAudioAdmin(){
    if(!localStorage.getItem("authorized"))
        return alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞!");
    audioAdmin.style.display="block";
}
</script>

</body>
</html>
