/* ================= CONFIG ================= */
const INDEX_PATH = "dictionary-v2/index.json";
const WORDS_PATH = "dictionary-v2/words";

/* ================= STATE ================= */
let indexData = [];
let query = "";

/* ================= INIT ================= */
window.onload = async () => {
  const search = document.getElementById("search");
  const btn = document.getElementById("search-btn");

  search.oninput = () => {
    query = search.value.trim().toLowerCase();
    render();
  };

  btn.onclick = () => {
    query = search.value.trim().toLowerCase();
    render();
  };

  await loadIndex();
  render();
};

/* ================= LOAD ================= */
async function loadIndex() {
  try {
    const res = await fetch(INDEX_PATH + "?v=" + Date.now());
    indexData = await res.json();
  } catch (e) {
    console.error(e);
    alert("Ошибка загрузки index.json");
  }
}

/* ================= SEARCH ================= */
function match(item, q) {
  if (!q) return true;

  const ru = (item.ru || "").toLowerCase();
  const pos = (item.pos || "").toLowerCase();
  const ings = (item.ings || []).join(" ").toLowerCase();

  return (
    ru.includes(q) ||
    pos.includes(q) ||
    ings.includes(q)
  );
}

/* ================= RENDER ================= */
function render() {
  const list = document.getElementById("list");
  list.innerHTML = "";

  const filtered = indexData.filter(item => match(item, query));

  document.getElementById("stats").textContent =
    `Слов: ${indexData.length} · Найдено: ${filtered.length}`;

  filtered.slice(0, 200).forEach(item => {
    list.insertAdjacentHTML("beforeend", cardHtml(item));
  });
}

/* ================= CARD ================= */
function cardHtml(item) {
  const ings = (item.ings || [])
    .map(i => `<div class="ingLine">• ${escapeHtml(i)}</div>`)
    .join("");

  return `
    <div class="card">
      <div class="wordRu">${escapeHtml(item.ru)}</div>
      ${item.pos ? `<div class="pos">${escapeHtml(item.pos)}</div>` : ""}
      ${ings || `<div class="muted">Нет перевода</div>`}
    </div>
  `;
}

/* ================= UTIL ================= */
function escapeHtml(str) {
  return (str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}
